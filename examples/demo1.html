<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="utf-8">
	<meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1">
	<meta name="viewport"
		content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no">
	<title>麒麟产业园区</title>
	<link href="../Build/Cesium/Widgets/widgets.css" rel="stylesheet">
	<link href="css/bootstrap.min.css" rel="stylesheet">
	<link href="css/pretty.css" rel="stylesheet">
	<link rel="stylesheet" href="css/ss.css">
	<script src="js/jquery.min.js"></script>
	<script src="js/Bubble.js"></script>
	<script src="js/bootstrap.min.js"></script>
	<script src="js/bootstrap-select.min.js"></script>
	<script src="./js/config.js"></script>
	<script type="text/javascript" src="../Build/Cesium/Cesium.js"></script>
	<style type="text/css">
		.cesium-viewer-bottom {
			display: none;
		}

		label {
			width: auto;
			display: inline-block;
		}
	</style>
</head>

<body>
	<div id="cesiumContainer"></div>
	<div id='loadingbar' class="spinner">
		<div class="spinner-container container1">
			<div class="circle1"></div>
			<div class="circle2"></div>
			<div class="circle3"></div>
			<div class="circle4"></div>
		</div>
		<div class="spinner-container container2">
			<div class="circle1"></div>
			<div class="circle2"></div>
			<div class="circle3"></div>
			<div class="circle4"></div>
		</div>
		<div class="spinner-container container3">
			<div class="circle1"></div>
			<div class="circle2"></div>
			<div class="circle3"></div>
			<div class="circle4"></div>
		</div>
	</div>
	<!-- <div id='toolbar' class="param-container tool-bar">
    <p>提示：</p>
    <span>点击房屋面以查看动态单体化效果</span>
</div> -->
	<blockquote id="bubble" class="bubble leaflet-popup-content-wrapper" style="width: 590px;height: 290px">
		<div class="leaflet-popup-content" style="width: 551px;">
			<div class="divMapInfoWindowContent" style="overflow-y: auto;overflow-x: hidden;margin-top:20px;">
				<div class="divInfo">
					<div class="popup-titleName">产业园: 科技新天地（麒麟产业园区1-4期）<span class="popup-titleName-en">Technology
							New Horizon
							(Phase I-IV Suzhou International Science Park)</span></div> 
					<div style="width:96%;"><label>地址<span
								class="popup-item-en">(Address)</span>：</label>xxxxxxxx大道1355号</div>
					<div><label>建筑面积<span class="popup-item-en">(Building Area)</span>：</label>325805㎡</div>
					<div><label>招商面积<span class="popup-item-en">(Business area)</span>：</label>65180㎡</div>
					<div><label>联系人<span class="popup-item-en">(Linkman)</span>：</label> 陈斌</div>
					<div><label>联系电话<span class="popup-item-en">(Number)</span>：</label> 18626288862</div>
					<div><label>联系座机<span class="popup-item-en">(Line phone)</span>：</label> 0512-67996574</div>
					<div><label>邮箱<span class="popup-item-en">(Email)</span>：</label> chenb@sispark.com.cn</div>
					<div style="width:96%;"><label>用途<span class="popup-item-en">(Use)</span>：</label>新一代信息技术</div>
					<div><label>备注<span class="popup-item-en">(Remarks)</span>：</label>-</div>

				</div>
			</div>
		</div>
	</blockquote>
	<script>
		function onload(Cesium) {
			var infoboxContainer = document.getElementById("bubble");
			var viewer = new Cesium.Viewer('cesiumContainer');
			var scene = viewer.scene;
			var camera = scene.camera;
			viewer.customInfobox = infoboxContainer;
			var bubble = new Bubble(scene, 'bubble');

			// 方法一，通过数据服务的形式添加单体化标识面
			// (推荐使用)
			var dataServiceUrl =
				'http://localhost:8090/iserver/services/data-qilin/rest/data/featureResults.rjson?returnContent=true'; // 数据服务URL
			var dataSourceName = 'qilin'; // 数据源名称
			var dataSetName = 'New_Region'; // 数据集名称
			// 加载倾斜摄影图层
			var promise = scene.open('http://localhost:8090/iserver/services/3D-qilin/rest/realspace');
			promise.then(function (obliqueLayers) {

				var handler = new Cesium.ScreenSpaceEventHandler(scene.canvas);
				handler.setInputAction(function (e) {
					// 首先移除之前添加标识实体
					viewer.entities.removeById('identify-area');
					// 获取点击位置笛卡尔坐标
					var position = scene.pickPosition(e.position);
					// 从笛卡尔坐标获取经纬度
					var cartographic = Cesium.Cartographic.fromCartesian(position);
					var longitude = Cesium.Math.toDegrees(cartographic.longitude);
					var latitude = Cesium.Math.toDegrees(cartographic.latitude);
					var height = cartographic.height;

					var queryPoint = { // 查询点对象
						x: longitude,
						y: latitude
					};

					queryByPoint(queryPoint, longitude, latitude, height);

				}, Cesium.ScreenSpaceEventType.LEFT_CLICK);

				// 去除加载动画
				// $('#toolbar').show();
				$('#loadingbar').remove();
			});

			// 通过点击查询用于表示单体化的面要素，添加到场景中高亮显示。
			function queryByPoint(queryPoint, lo, la, he) {
				var queryObj = {
					"getFeatureMode": "SPATIAL",
					"spatialQueryMode": "INTERSECT",
					"datasetNames": [dataSourceName + ":" + dataSetName],
					"geometry": {
						id: 0,
						parts: [1],
						points: [queryPoint],
						type: "POINT"
					}
				};

				queryObjJSON = JSON.stringify(queryObj); // 转化为JSON字符串作为查询参数

				$.ajax({
					type: "post",
					url: dataServiceUrl,
					data: queryObjJSON,
					success: function (result) {
						var resultObj = JSON.parse(result);
						if (resultObj.featureCount > 0) {
							addClapFeature(resultObj.features[0]);
							console.log(resultObj)
						}
						if (resultObj.features[0] != undefined) {
							var bubbleposition = new Cesium.Cartesian3.fromDegrees(lo, la, he);
							// var h1 = document.getElementById('h1');
							// h1.innerHTML = resultObj.features[0].fieldValues[10];
							bubble.showAt(bubbleposition);
						} else if (resultObj.features[0] == undefined) {
							bubble.visibility(false);
						}
					},
					error: function (msg) {
						console.log(msg);
					}
				})
			}

			// 将数据服务查询到的要素添加到场景中高亮显示，表示选中效果。
			function addClapFeature(feature) {
				var lonLatArr = getLonLatArray(feature.geometry.points);
				viewer.entities.add({
					id: 'identify-area',
					name: '单体化标识面',
					polygon: {
						hierarchy: Cesium.Cartesian3.fromDegreesArray(lonLatArr),
						material: new Cesium.Color(1.0, 0.0, 0.0, 0.3),
					},
					classificationType: Cesium.ClassificationType.S3M_TILE // 贴在S3M模型表面
				});
			}

			// 得到[经度,纬度,经度,纬度...]形式的数组，用于构造面。
			function getLonLatArray(points) {
				var point3D = [];
				points.forEach(function (point) {
					point3D.push(point.x);
					point3D.push(point.y);
				});
				return point3D;
			}

		}
		if (typeof Cesium !== 'undefined') {
			window.startupCalled = true;
			onload(Cesium);
		}
	</script>
</body>

</html>